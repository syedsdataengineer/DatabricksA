-- Query 1: Cost and DBU Consumption per Cluster
SELECT 
    cluster_id,
    cluster_name,
    workspace_id,
    SUM(dbu_hours) AS total_dbu_hours,
    SUM(dbu_hours * dbu_price) AS total_cost_usd,
    COUNT(DISTINCT job_id) AS total_jobs,
    AVG(dbu_hours) AS avg_dbu_per_job,
    MAX(dbu_hours) AS max_dbu_per_job
FROM system.information_schema.compute_warehouses
GROUP BY cluster_id, cluster_name, workspace_id
ORDER BY total_cost_usd DESC;

-- Query 2: Cost Breakdown by Job (ETL Pipelines)
SELECT 
    job_id,
    job_name,
    cluster_id,
    SUM(dbu_hours) AS total_dbu_hours,
    SUM(dbu_hours * dbu_price) AS total_cost_usd,
    COUNT(DISTINCT run_id) AS total_runs,
    AVG(dbu_hours) AS avg_dbu_per_run,
    MAX(dbu_hours) AS max_dbu_per_run
FROM system.information_schema.jobs
GROUP BY job_id, job_name, cluster_id
ORDER BY total_cost_usd DESC;

-- Query 3: DBU Consumption Over Time (Trends)
SELECT 
    DATE_TRUNC('day', start_time) AS date,
    SUM(dbu_hours) AS daily_dbu_hours,
    SUM(dbu_hours * dbu_price) AS daily_cost_usd,
    COUNT(DISTINCT job_id) AS unique_jobs,
    COUNT(DISTINCT cluster_id) AS unique_clusters
FROM system.information_schema.query_history
GROUP BY date
ORDER BY date DESC;

-- Query 4: Idle Cluster Analysis (Clusters with High Idle Time)
SELECT 
    cluster_id,
    cluster_name,
    workspace_id,
    SUM(idle_time) AS total_idle_time_minutes,
    SUM(dbu_hours * dbu_price) AS total_cost_usd,
    (SUM(idle_time) / SUM(active_time)) * 100 AS idle_percentage,
    COUNT(DISTINCT job_id) AS jobs_on_cluster
FROM system.information_schema.clusters
WHERE idle_time > 0
GROUP BY cluster_id, cluster_name, workspace_id
ORDER BY idle_percentage DESC;

-- Query 5: Total Cost by Workspace
SELECT 
    workspace_id,
    workspace_name,
    SUM(dbu_hours * dbu_price) AS total_cost_usd,
    COUNT(DISTINCT cluster_id) AS total_clusters,
    COUNT(DISTINCT job_id) AS total_jobs,
    AVG(dbu_hours) AS avg_dbu_per_cluster
FROM system.information_schema.billing
GROUP BY workspace_id, workspace_name
ORDER BY total_cost_usd DESC;











SELECT 
    c.cluster_id,
    c.cluster_name,
    u.workspace_id,
    u.account_id,
    SUM(u.usage_quantity) AS total_dbu_usage_quantity,
    SUM(
        CAST(u.usage_quantity AS DECIMAL(38,18)) * 
        CAST(get_json_object(p.pricing, '$.default') AS DECIMAL(38,18))
    ) AS total_cost_usd,
    COUNT(DISTINCT job_id) AS total_jobs,
    AVG(u.usage_quantity) AS avg_usage_per_job,
    MAX(u.usage_quantity) AS max_usage_per_job,
    FORMAT_NUMBER(
        SUM(
            CAST(u.usage_quantity AS DECIMAL(38,18)) * 
            CAST(get_json_object(p.pricing, '$.default') AS DECIMAL(38,18))
        ), 
        2
    ) AS formatted_cost_usd
FROM system.billing.usage AS u
JOIN system.compute.clusters AS c
    ON u.workspace_id = c.workspace_id
JOIN system.billing.list_prices AS p
    ON u.account_id = p.account_id
WHERE 
    get_json_object(p.pricing, '$.default') IS NOT NULL  -- Ensures no NULL values
    AND get_json_object(p.pricing, '$.default') != ''  -- Ensures empty values don't break the query
GROUP BY c.cluster_id, c.cluster_name, u.workspace_id, u.account_id
ORDER BY total_cost_usd DESC;

























SELECT 
    DATE_TRUNC('month', u.usage_date) AS month, 
    u.cloud,
    SUM(u.usage_quantity) AS total_dbus_consumed
FROM system.billing.usage u
WHERE u.usage_unit = 'DBU'
GROUP BY DATE_TRUNC('month', u.usage_date), u.cloud
ORDER BY month ASC;

